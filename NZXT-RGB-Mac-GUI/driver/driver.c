//
//  driver.c
//  NZXT-RGB-Mac-GUI
//
//  Created by Harrison White on 5/17/19.
//  Copyright Â© 2019 Harrison White. All rights reserved.
//
//  This program is free software: you can redistribute it and/or modify
//  it under the terms of the GNU General Public License as published by
//  the Free Software Foundation, either version 3 of the License, or
//  (at your option) any later version.
//
//  This program is distributed in the hope that it will be useful,
//  but WITHOUT ANY WARRANTY; without even the implied warranty of
//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//  GNU General Public License for more details.
//
//  You should have received a copy of the GNU General Public License
//  along with this program.  If not, see <http://www.gnu.org/licenses/>.
//

#include "driver.h"
#include "hidapi.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define MAX_STR 255

unsigned char on1_bin[] = {
    0x02, 0x4b, 0x00, 0x00, 0x02, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff
};
unsigned int on1_bin_len = 65;

unsigned char on2_bin[] = {
    0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0x00
};
unsigned int on2_bin_len = 65;

unsigned char off1_bin[] = {
    0x02, 0x4b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00
};
unsigned int off1_bin_len = 65;

unsigned char off2_bin[] = {
    0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00
};
unsigned int off2_bin_len = 65;

// handle is initialized once in driver_init() and used until driver_teardown() is called
static hid_device *handle = NULL;

void init_handle(void);
void send_cmd(unsigned const char *cmd, size_t len);

void driver_init() {
    // Initialize the hidapi library
    hid_init();
    init_handle();
}

// separate function for initializing device handle in case it has to be
// re-initialized (in case the computer goes to sleep and then awakens, etc.)
void init_handle() {
    // Open the device using the VID, PID,
    // and optionally the Serial number.
    handle = hid_open(0x1e71, 0x2006, NULL);
    if (!handle) {
        fprintf(stderr, "could not get device handle; ensure device is connected and has correct ID\n");
        return;
    }
}

void driver_teardown() {
    // Finalize the hidapi library
    hid_exit();
}

void send_cmd(unsigned const char *cmd, size_t len) {
    if (hid_write(handle, cmd, len) == -1) {
        // handle may no longer be valid
        // (this will happen if the computer has gone to sleep and was awakened)
        init_handle();
        hid_write(handle, cmd, len);
    }
}

void set_lights_on(bool on) {
    if (handle == NULL) {
        fprintf(stderr, "error: function called without device handle; ensure driver_init() was called\n");
        return;
    }
    
    if (on) {
        printf("turning lights on\n");
        send_cmd(on1_bin, on1_bin_len);
        send_cmd(on2_bin, on2_bin_len);
    } else {
        printf("turning lights off\n");
        send_cmd(off1_bin, off1_bin_len);
        send_cmd(off2_bin, off2_bin_len);
    }
}
